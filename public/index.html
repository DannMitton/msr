<!DOCTYPE html>
<html lang="en">
<!--
================================================================================
MY SUNG RUSSIAN (MSR) - IPA Transcription Tool for Singers
================================================================================
Version: 4.16
Last Updated: 2026-01-13
Developer: Dann Mitton
Assistant: Claude (Anthropic)

CHANGES IN 4.16:
- Syllable Lock feature: click üîí to prevent vowel reduction on any syllable
- Locked syllables retain full vowel quality even when unstressed
- Visual feedback: üîí (faded) = unlocked, üîì (solid) = locked
- Added lockedSyllables parameter to transcribeSyllable() function
- Updated 5 vowel reduction branches (–∞, –æ, –µ, —è, —ç) to respect locks
- New functions: toggleLock(), retranscribeSyllablesWithLock()

CHANGES IN 4.15:
- Wiktionary Harvest System: automatically collects verified stress data
- Harvested words stored in localStorage, persist across sessions
- Only harvests words NOT already in Vuizur dictionary (no duplicates)
- Console API: MSR.harvest.stats(), .export(), .download(), .data()
- Tracks word frequency (count) and timestamps for corpus analysis
- Foundation for growing art-song-specific vocabulary over time
- Developer mode: triple-click version number to unlock harvest indicator
- Harvest indicator (üåæ + count) shows next to version when unlocked
- One-click download from indicator (no confirmation dialogs)

CHANGES IN 4.14:
- Code cleanup: removed 957 lines of dead code
- Removed GRAYSON_RULES object (722 lines) - replaced by generateCuratedExplanations()
- Removed old rule-lookup functions (ruleMatchScore, findApplicableRules, etc.)
- Removed moveCharLeft/moveCharRight - replaced by drag-and-drop IPA editor
- Removed renderStressEditor/toggleWordEditor/setStressFromSingersView - unused
- Fixed Wiktionary modal visibility (now uses .show class)
- Fixed click handler on stress-unverified icon (pointer-events on pseudo-elements)

CHANGES IN 4.13:
- Fixed word card tiling/spacing issue
- Removed .word-card-sizer element (visibility:hidden still took up layout space)
- Removed duplicate .stress-indicator CSS rule
- Cards now tile contiguously with consistent 10px gaps

CHANGES IN 4.12:
- User Profile modal (gear icon) with country/jurisdiction setting
- Copyright terms adjust by country (CA/EU: life+70, USA: complex, MX: life+100)
- Profile persists in localStorage across sessions
- Continuation headers for page 2+: "Title, cont'd" left, "Poet / Composer" right
- Compact continuation header with smaller font, same divider line
- isPublicDomain() now uses user's jurisdiction for accurate PD calculation

CHANGES IN 4.11:
- Predictive autocomplete for Poet and Composer fields
- 50+ composers and 45+ poets with Cyrillic+Latin search aliases
- Type "—á–∞–π–∫" or "tchai" or "chai" ‚Üí finds Tchaikovsky
- Public domain indicators: ‚úì (life+70) vs ¬© (potentially copyrighted)
- Dates auto-populate from database selection
- Canonical spelling enforced (MSR controls output format)
- Keyboard navigation: ‚Üë/‚Üì to select, Enter to confirm, Esc to close
- Freeform entry still allowed for unlisted names

CHANGES IN 4.10:
- Metadata input panel for Singer's View
- Required fields: Title, Poet, Composer
- Optional fields: Opus/Catalogue, Page Size (Letter/A4)
- Panel collapses after completion, shows summary
- Validation highlights missing required fields
- Mobile-friendly: 44px touch targets, stacks on narrow screens
- Canvas re-renders on metadata changes

CHANGES IN 4.9:
- Full-page PDF template (Letter 8.5x11 or A4)
- Proper header zone: Title, Poet (dates), Composer (dates), Opus
- Proper footer zone: Attribution, copyright disclaimer, page numbers
- Document metadata structure for cataloguing
- Public domain vs copyright-aware disclaimer text
- Pagination support (calculates total pages)
- Dynamic filename from title

CHANGES IN 4.8:
- Singer's View now renders to zoomable canvas viewport
- Pinch-to-zoom and pan support for mobile
- Live document status indicator (Updating.../Ready)
- Document metadata and hash for future cataloguing
- PDF export now uses same canvas (WYSIWYG)
- Zoom controls: +/- buttons and reset
- Removed html2canvas dependency (native canvas rendering)

CHANGES IN 4.7:
- Added Chapter 9 Style Presets system
- Four presets: Sung Russian (Grayson), Modern Standard, Petersburg, Choir
- Style toggles: vowel reduction (ikanye/ekanye/none), —â pronunciation, 
  velar+–∏–π endings, regressive palatalization extent
- Pre-revolutionary orthography normalization (—£‚Üí–µ, —ñ‚Üí–∏, —µ‚Üí–∏, —≥‚Üí—Ñ)
- Style presets UI in Notation Preferences section
- Each preset documented with Grayson page references

CHANGES IN 4.6:
- Added Chapter 8 Sections 2-5 exceptions (deverbal forms, palatalized —Ü, pure exceptions)
- Restored ‚ü®—ë‚ü© in Cyrillic display when stress changes
- Pure exception indicators (‚ö†Ô∏è) with tooltips
- Why screen integration for pure exceptions (Tier 0.5)
- 100+ exception dictionary entries

CHANGES IN 4.2:
- Added Chapter 5 palatalization examples (12 entries including ‚ü®—Ä‚ü© gating contrasts)
- Refined ‚ü®—Ä‚ü© gating rule: stressed front vowel unlocks ‚ü®—Ä‚ü© for regressive palatalization
- Added –≤–µ—Ä–Ω—É—Ç—å, —á–µ—Ä–Ω–∏–∫–∞ as contrast examples (unstressed = —Ä stays hard)
- Fixed —Ä palatalization logic for stressed front vowel gating
- Total exception dictionary: 250 entries
- Created GRAYSON_CH5_PALATALIZATION_RULES.js for Why screen citations

CHANGES IN 4.1:
- Added 25 Grayson verified examples (rule demonstrations)
- Total exception dictionary: 238 entries
- 100% test suite pass rate

CHANGES IN 4.0:
- Expanded EXCEPTION_WORDS from 75 to 213 entries
- Complete Appendix F integration (154 loan words)
- All hard-–µ, unreduced-–æ, —à—é/–∂—é, and —å–æ exceptions included

CHANGES IN 3.5:
- Added –≥–∫‚Üí/xk/ cluster rule (–º—è–≥–∫–∏–π, –ª—ë–≥–∫–∏–π families) per Grayson p. 240
- Added –≥—á‚Üí/x/ rule (–º—è–≥—á–µ comparatives)
- Expanded EXCEPTION_WORDS from 10 to 75+ entries
- Added Chapter 8.5 common exceptions (—Å—á–∞—Å—Ç—å–µ, —Ü–µ—Ä–∫–æ–≤—å, –∞–Ω–≥–µ–ª, –∞–≥–∞, —Ä—É—Å—Å–∫–∏–π, —Å–µ–π—á–∞—Å, —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å)
- Added Appendix F loan words (–∫–∞—Ñ–µ, —Ç–µ–º–ø, —Ç–µ–Ω–Ω–∏—Å, —Ä–∞–¥–∏–æ, –±—Ä–æ—à—é—Ä–∞, –±–∞—Ç–∞–ª—å–æ–Ω, etc.)
- All exceptions now have Grayson page citations

LICENSE:
- Software: AGPL-3.0
- Educational content: CC BY-NC-SA 4.0
- Stress dictionary: Vuizur (AGPL-3.0, Wiktionary-derived)

AUTHORITATIVE SOURCE:
Craig Grayson, "Russian Lyric Diction: A Practical Guide with Introduction 
and Annotations" (University of Washington, 2012)

================================================================================
ARCHITECTURE OVERVIEW
================================================================================

This is a single-file HTML application with embedded CSS and JavaScript.
Structure:
1. <head> - Fonts, CSS styles
2. <body> - UI structure (header, input, output areas, footer)
3. <script> - All transcription logic and interactivity

KEY CONCEPTS:

1. CLUSTER-FIRST TRANSCRIPTION
   - Special consonant clusters are matched BEFORE character-by-character processing
   - Handles assimilation (—Å–∂‚Üí íÀê), deletion (—Å—Ç–Ω‚Üísn), reflexives (-—Ç—å—Å—è‚ÜítÀês å)
   - Exception words dictionary for cross-syllable patterns (—Å–µ—Ä–¥—Ü–µ, —Å–æ–ª–Ω—Ü–µ)

2. SIBLING VIEW ARCHITECTURE  
   - Workspace (word-cards) and Singer's View (interlinear) are SIBLINGS
   - Both views read from the same processedWords[] array
   - Edit in either view, changes sync to both
   - Neither is "home" ‚Äî user flips freely between them

3. CARD FLIP SYLLABLE BOUNDARY EDITOR
   - Word cards flip (3D CSS transform) to reveal syllable editor on back
   - Users can move consonants across syllable boundaries using ‚Üê ‚Üí buttons
   - Soft/hard signs (—å/—ä) move with their consonants
   - IPA retranscribes automatically after changes

4. NOTATION PREFERENCES
   - Toggle buttons for cosmetic IPA variations
   - ‚ü®—â‚ü©: [ É ≤ É ≤] ‚Üî [ É ≤Àê] (geminate vs length mark)
   - soft ‚ü®–Ω‚ü©: […≤] ‚Üî [n ≤] (palatal nasal vs palatalized n)
   - Stored in notationPrefs object, applied via applyNotationPreferences()

================================================================================
KNOWN ISSUES / TODO
================================================================================

[ ] Vuizur stress dictionary integration (currently placeholder)
[ ] Gloss/translation input in Singer's View (shows "___" placeholder)
[ ] Mobile testing and refinement needed
[ ] Extended repertoire testing (Rachmaninoff, Tchaikovsky)
[ ] Print stylesheet refinement for Singer's View

SYLLABIFICATION:
- Fixed —å/—ä bug (was treating as syllable boundary, now stays with consonant)
- User can manually adjust boundaries via card flip editor
- Open syllable preference for singers (CV.CV pattern)

================================================================================
COLOUR STORY: IMPERIAL PORPHYRY
================================================================================

Background: Deep red porphyry with feldspar inclusions
Primary: #a33d3d (rich red)
Dark: #6e2424, #4a1818
Accent Gold: #d4a820 (toggle alternate, gear icon)
Terracotta: #d4784a (toggle default)
Cream: #fffefb, #faf8f6 (cards, containers)
Border: #c4b5a8, #d4c4b0

================================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sung Russian (MSR) - IPA Transcription Tool</title>
    
    <!-- Google Fonts: Noto Sans (UI) + Noto Serif (Cyrillic/IPA) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,600;0,700;1,400&family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="themes/default.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>My Sung Russian <span class="msr-abbrev">(MSR)</span></h1>
                </div>
                <div class="header-actions">
                    <a href="#" class="header-link" onclick="event.preventDefault(); /* TODO: showAbout() */">About</a>
                    <button class="header-gear" onclick="openProfileModal()" title="User Profile">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="header-rule"></div>
        </header>

        <div class="main-content">
            <div class="info-box">
                <h3>How to Use</h3>
                <ol class="instructions">
                    <li>Type or paste your Russian text below.</li>
                    <li>Click a syllable in the resulting word-cards to assign and reassign stress.</li>
                    <li>Use your finished transcription to start singing in Russian. <em>–í–ø–µ—Ä—ë–¥!</em></li>
                </ol>
            </div>

            <div class="input-section">
                <label for="russianInput">Russian Text:</label>
                <div class="textarea-wrapper">
                    <textarea id="russianInput"></textarea>
                    <div class="animated-placeholder" id="animatedPlaceholder">
                        <span class="placeholder-ru">–í–≤–µ–¥–∏—Ç–µ —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å...</span>
                        <span class="placeholder-en">Enter Russian text here...</span>
                    </div>
                </div>
                <div class="input-controls">
                    <button onclick="processText()">Transcribe</button>
                    <button class="secondary-button" onclick="clearAll()">Clear</button>
                    <button class="secondary-button" onclick="runCh6Tests()" style="background:#d4784a;color:white;">Run Ch6 Tests</button>
                </div>
            </div>
            
            <div id="viewToggle" class="view-toggle" style="display: none;">
                <button class="view-tab active" id="workspaceTab" onclick="switchView('workspace')">Workspace</button>
                <button class="view-tab" id="singersTab" onclick="switchView('singers')">Singer's View</button>
            </div>
            
            <div id="workspaceView">
                <div id="output"></div>
            </div>
            
            <div id="singersView" class="singers-view" style="display: none;">
                <!-- Metadata Input Panel -->
                <div class="metadata-panel" id="metadataPanel">
                    <div class="metadata-header" onclick="toggleMetadataPanel()">
                        <span class="metadata-summary" id="metadataSummary">Enter work details</span>
                        <span class="metadata-toggle" id="metadataToggle">‚ñº</span>
                    </div>
                    <div class="metadata-form" id="metadataForm">
                        <div class="metadata-row">
                            <div class="metadata-field full-width">
                                <label for="metaTitle">Title <span class="required">*</span></label>
                                <input type="text" id="metaTitle" placeholder="e.g., –ù–µ –ø–æ–π, –∫—Ä–∞—Å–∞–≤–∏—Ü–∞, –ø—Ä–∏ –º–Ω–µ" 
                                       onchange="updateDocumentMeta()" oninput="updateDocumentMeta()">
                            </div>
                        </div>
                        <div class="metadata-row two-col">
                            <div class="metadata-field">
                                <label for="metaPoet">Poet <span class="required">*</span></label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="metaPoet" placeholder="e.g., Pushkin or –ü—É—à–∫–∏–Ω"
                                           oninput="handlePoetInput(this)" 
                                           onkeydown="handleAutocompleteKey(event, 'poet')"
                                           onblur="setTimeout(() => hideAutocomplete('poet'), 200)"
                                           autocomplete="off">
                                    <div class="autocomplete-dropdown" id="poetDropdown"></div>
                                </div>
                            </div>
                            <div class="metadata-field">
                                <label for="metaComposer">Composer <span class="required">*</span></label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="metaComposer" placeholder="e.g., Rachmaninoff or –†–∞—Ö–º–∞–Ω–∏–Ω–æ–≤"
                                           oninput="handleComposerInput(this)"
                                           onkeydown="handleAutocompleteKey(event, 'composer')"
                                           onblur="setTimeout(() => hideAutocomplete('composer'), 200)"
                                           autocomplete="off">
                                    <div class="autocomplete-dropdown" id="composerDropdown"></div>
                                </div>
                            </div>
                        </div>
                        <div class="metadata-row two-col">
                            <div class="metadata-field">
                                <label for="metaOpus">Opus / Catalogue</label>
                                <input type="text" id="metaOpus" placeholder="e.g., Op. 4, No. 4"
                                       onchange="updateDocumentMeta()" oninput="updateDocumentMeta()">
                            </div>
                            <div class="metadata-field">
                                <label for="metaPageSize">Page Size</label>
                                <div class="page-size-toggle">
                                    <button type="button" class="size-btn active" id="btnLetter" onclick="setPageSize('letter')">Letter</button>
                                    <button type="button" class="size-btn" id="btnA4" onclick="setPageSize('a4')">A4</button>
                                </div>
                            </div>
                        </div>
                        <div class="metadata-validation" id="metadataValidation"></div>
                    </div>
                </div>
                
                <!-- Zoomable Canvas Viewport -->
                <div class="canvas-viewport" id="canvasViewport">
                    <canvas id="singersCanvas"></canvas>
                </div>
                <!-- Zoom controls -->
                <div class="viewport-controls">
                    <button class="zoom-btn" onclick="zoomCanvas(0.9)" title="Zoom out">‚àí</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="zoomCanvas(1.1)" title="Zoom in">+</button>
                    <button class="zoom-btn reset" onclick="resetCanvasView()" title="Reset view">‚ü≤</button>
                </div>
                <!-- Document status indicator -->
                <div class="document-status" id="documentStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Live</span>
                </div>
            </div>
            <div id="singersViewControls" class="output-controls" style="display: none;">
                <button onclick="copySingersView()">Copy</button>
                <button onclick="printSingersView()">Print</button>
                <button onclick="exportToPDF()">Export PDF</button>
            </div>
            
            <details class="preferences-panel">
                <summary>Preferences ‚ñæ</summary>
                
                <!-- Style Presets as Radio Buttons -->
                <div class="style-presets-radio">
                    <div class="preset-option">
                        <input type="radio" id="preset-grayson" name="stylePreset" value="sung_russian_grayson" checked onchange="applyStylePreset(this.value)">
                        <label for="preset-grayson" title="Traditional Old Muscovite / Stage pronunciation&#10;‚Ä¢ Ikanye (–µ‚Üí/…™/)&#10;‚Ä¢ Shshokanye (—â‚Üí/ É ≤ É ≤/)&#10;‚Ä¢ Stage endings (-–∫–∏–π‚Üí/k…®j/)&#10;‚Ä¢ Full regressive palatalization">Grayson</label>
                    </div>
                    <div class="preset-option">
                        <input type="radio" id="preset-csr" name="stylePreset" value="modern_standard" onchange="applyStylePreset(this.value)">
                        <label for="preset-csr" title="Contemporary Standard Russian&#10;‚Ä¢ Ikanye (–µ‚Üí/…™/)&#10;‚Ä¢ Shshokanye (—â‚Üí/ É ≤ É ≤/)&#10;‚Ä¢ Modern endings (-–∫–∏–π‚Üí/k ≤ij/)&#10;‚Ä¢ Partial regressive palatalization">CSR</label>
                    </div>
                    <div class="preset-option">
                        <input type="radio" id="preset-petersburg" name="stylePreset" value="petersburg" onchange="applyStylePreset(this.value)">
                        <label for="preset-petersburg" title="Petersburg / Northern tradition&#10;‚Ä¢ Ekanye (–µ‚Üí/…õ/)&#10;‚Ä¢ Shchokanye (—â‚Üí/ É ≤t É ≤/)&#10;‚Ä¢ Modern endings (-–∫–∏–π‚Üí/k ≤ij/)&#10;‚Ä¢ Partial regressive palatalization">Peterburgian</label>
                    </div>
                    <div class="preset-option">
                        <input type="radio" id="preset-choir" name="stylePreset" value="choir" onchange="applyStylePreset(this.value)">
                        <label for="preset-choir" title="Choral (no vowel reduction)&#10;‚Ä¢ No reduction (–µ‚Üí/…õ/, –∞/–æ‚Üí/…ë/)&#10;‚Ä¢ Shshokanye (—â‚Üí/ É ≤ É ≤/)&#10;‚Ä¢ Modern endings&#10;For ensemble vowel matching">Choir</label>
                    </div>
                </div>
                
                <!-- Notation Toggles (cosmetic) - stacked vertically, flush right -->
                <div class="notation-toggles-stack">
                    <div class="notation-toggle-item" onclick="toggleShchaNotation()">
                        <span class="toggle-label-small">‚ü®—â‚ü©</span>
                        <span class="glyph-toggle-small" id="shchaToggle" title="Click to toggle between  É ≤ É ≤ and  É ≤Àê notation"> É ≤ É ≤</span>
                    </div>
                    <div class="notation-toggle-item" onclick="togglePalatalnNotation()">
                        <span class="toggle-label-small">soft ‚ü®–Ω‚ü©</span>
                        <span class="glyph-toggle-small" id="palatalnToggle" title="Click to toggle between …≤ and n ≤ notation">…≤</span>
                    </div>
                </div>
            </details>

            <div id="output"></div>
        </div>

        <footer id="mainFooter" class="collapsed" onclick="toggleFooter()">
            <div class="footer-collapsed-label">
                My Sung Russian (MSR) <span id="versionNumber" onclick="event.stopPropagation()">v4.16</span> ‚Äî tap for credits & license <span class="footer-arrow">‚ñ≤</span>
            </div>
            <div class="footer-main">
            <p>
                <strong>My Sung Russian (MSR)</strong> <span id="versionNumberExpanded" onclick="event.stopPropagation()">v4.16</span>
            </p>
            <p style="margin-top: 8px; font-size: 0.85em; line-height: 1.6;">
                MSR's transcription rules are drawn from Craig Grayson's doctoral dissertation <a href="https://digital.lib.washington.edu/server/api/core/bitstreams/96b596ce-3a65-41c8-a45f-77b2e94ae48a/content" target="_blank" onclick="event.stopPropagation()"><em>Russian Lyric Diction: A Practical Guide with Introduction and Annotations and a Bibliography with Annotations on Selected Sources</em></a> (University of Washington, 2012). Developed and maintained by Dann Mitton (2026). Stress dictionary via <a href="https://github.com/Vuizur/add-stress-to-epub" target="_blank" onclick="event.stopPropagation()">Vuizur</a> (AGPL-3.0).
            </p>
            <p style="margin-top: 10px; font-size: 0.85em; line-height: 1.6;">
                My Sung Russian is noncommercial and is intended for use by singers, teachers, and scholars. This tool is offered freely. Neither it nor its output may be repackaged for sale. Use it generously and improve it. Software licensed under <a href="https://www.gnu.org/licenses/agpl-3.0.en.html" target="_blank" onclick="event.stopPropagation()">AGPL-3.0</a>. Educational content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" onclick="event.stopPropagation()">CC BY-NC-SA 4.0</a>.
            </p>
            </div>
        </footer>
    </div>
    
    <!-- User Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>User Profile</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-field">
                    <label for="profileCountry">Country / Jurisdiction</label>
                    <select id="profileCountry" onchange="updateCopyrightPreview()">
                        <option value="">‚Äî Select your country ‚Äî</option>
                        <optgroup label="North America">
                            <option value="CA">Canada</option>
                            <option value="US">United States</option>
                            <option value="MX">Mexico</option>
                        </optgroup>
                        <optgroup label="Europe">
                            <option value="EU">European Union</option>
                            <option value="GB">United Kingdom</option>
                            <option value="RU">Russia</option>
                            <option value="UA">Ukraine</option>
                            <option value="CH">Switzerland</option>
                        </optgroup>
                        <optgroup label="Asia Pacific">
                            <option value="AU">Australia</option>
                            <option value="NZ">New Zealand</option>
                            <option value="JP">Japan</option>
                            <option value="KR">South Korea</option>
                            <option value="CN">China</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="OTHER">Other (use life + 70)</option>
                        </optgroup>
                    </select>
                    <div class="field-hint">
                        Copyright terms vary by country. This helps MSR show accurate public domain status for composers and poets.
                    </div>
                    <div class="copyright-preview" id="copyrightPreview">
                        Select a country to see copyright terms.
                    </div>
                </div>
                <div class="profile-field">
                    <label for="profileName">Your Name (optional)</label>
                    <input type="text" id="profileName" placeholder="For PDF attribution">
                    <div class="field-hint">
                        Appears in exported PDFs as "Transcription by [name]"
                    </div>
                </div>
                <div class="profile-field">
                    <label for="profileInstitution">Institution (optional)</label>
                    <input type="text" id="profileInstitution" placeholder="e.g., University of Toronto">
                    <div class="field-hint">
                        Your school, studio, or organization
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveUserProfile()">Save Profile</button>
            </div>
        </div>
    </div>
    
    <!-- First-Launch Onboarding Modal -->
    <div class="modal-overlay" id="onboardingModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2>Welcome to My Sung Russian</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: #444; line-height: 1.5;">
                    MSR helps singers transcribe Russian text into IPA for lyric diction study.
                </p>
                <div class="profile-field">
                    <label for="onboardingName">What name should appear on your transcriptions?</label>
                    <input type="text" id="onboardingName" placeholder="e.g., Dann Mitton" style="font-size: 16px; padding: 12px;">
                    <div class="field-hint">
                        This appears in PDF exports. You can change it anytime in Settings.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="skipOnboarding()">Skip</button>
                <button class="modal-btn modal-btn-primary" onclick="completeOnboarding()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Stress Source Modal - asks user vs composer -->
    <div class="modal-overlay" id="stressSourceModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2>Who assigned this stress?</h2>
                <button class="modal-close" onclick="closeStressSourceModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p style="margin-bottom: 20px; color: #4a5568;">
                    Moving stress from the dictionary position on <strong id="stressSourceWord"></strong>
                </p>
                <button class="modal-btn" onclick="confirmStressSource('user')" style="width: 100%; margin-bottom: 12px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);">
                    üé§ My choice (for learning/practice)
                </button>
                <button class="modal-btn" onclick="confirmStressSource('composer')" style="width: 100%; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);">
                    üéº Composer's score (published this way)
                </button>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="modal-btn modal-btn-secondary" onclick="closeStressSourceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- External data files -->
    <script src="../data/yo-exceptions.js"></script>
    <script src="../data/stress-corrections.js"></script>
    <script src="../data/exception-words.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- MSR Core (bundled) -->
    <script src="msr.js"></script>
    
    <!-- Golden-master tests (run in console: runGoldenTests()) -->
    <script src="../tests/golden.js"></script>
    
    <!-- Exception dictionary audit (run in console: auditExceptions()) -->
    <script src="../tests/audit-exceptions.js"></script>
    
    <!-- Remove redundant exceptions (run: removeRedundantExceptions(auditExceptions())) -->
    <script src="../tests/remove-redundant.js"></script>
</body>
</html>
